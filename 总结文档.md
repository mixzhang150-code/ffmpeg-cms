# 云转码系统项目审计报告

## 1. 项目概述

### 1.1 项目基本信息

- **项目名称**: 云转码系统(express-ffmpeg)
- **项目类型**: 视频转码与流媒体服务平台
- **主要功能**: 视频上传、转码、HLS切片、水印添加、防盗链、CMS系统、会员权限管理等
- **技术栈**: Node.js + Express.js + MongoDB + FFmpeg + Redis

### 1.2 目录结构

项目采用标准的Express.js应用结构，主要包含以下目录和文件：

```
├── app.js             # 应用程序入口文件
├── bin/               # 启动脚本目录
│   └── www           # 启动服务器脚本
├── controller/        # 控制器目录
│   ├── admin.js      # 管理员功能控制器
│   └── cms.js        # CMS功能控制器
├── helper/            # 工具函数目录
│   ├── ffmpeg.js     # FFmpeg转码功能
│   ├── ffmpegcut.js  # 视频剪切功能
│   ├── newffmpeg.js  # 新版转码功能
│   ├── listsffmpeg.js # 队列转码功能
│   └── rediscache.js # Redis缓存功能
├── models/            # 数据模型目录
├── schemas/           # 数据模式定义目录
├── routes/            # 路由配置目录
├── public/            # 静态资源目录
├── views/             # 视图模板目录
└── package.json       # 项目配置和依赖文件
```

## 2. 核心功能分析

### 2.1 视频转码与HLS切片

项目核心功能基于FFmpeg实现，主要包括：

- **转码功能**: 支持将各种格式视频转换为H.264编码，AAC音频的MP4格式
- **HLS切片**: 将视频切分为10秒一段的TS文件，生成M3U8索引文件
- **水印添加**: 支持图片水印和文字水印，可自定义位置和样式
- **字幕处理**: 支持VTT字幕文件
- **分辨率适配**: 支持480p、720p、1080p等多种分辨率
- **TS加密**: 支持HLS加密，通过key.info和ts.key文件实现
- **智能秒切**: 对于已符合要求的视频，可以直接进行切片而无需转码
- **缩略图生成**: 自动生成视频截图，支持sprite格式缩略图

转码流程由以下几个主要函数处理：
- `transcode`: 主转码函数，协调整个转码过程
- `ffmpegtransandchunk`: 转码并切片功能
- `ffmpegtrans`: 仅转码功能
- `chunk`: 仅切片功能
- `screenshots`: 截图生成功能

### 2.2 用户与权限管理

系统实现了多级用户管理：

- **管理员系统**: 基于session的简易管理员验证
- **会员系统**: 支持用户注册、登录、会员等级管理
- **卡券系统**: 支持生成和管理会员卡券
- **权限控制**: 非会员和普通会员有不同的观看权限

用户模型主要包含以下字段：
```javascript
{
    username: String,  // 用户名
    email: String,     // 邮箱
    password: String,  // 密码（明文存储，存在安全隐患）
    level: Number,     // 用户等级，默认为1
    duedate: Date,     // 到期时间
    createAt: Date     // 创建时间
}
```

### 2.3 CMS内容管理系统

系统内置了完整的CMS功能：

- **视频管理**: 上传、分类、搜索、编辑视频
- **分类管理**: 创建和管理视频分类
- **文章管理**: 发布、编辑、删除文章
- **图集管理**: 创建和管理图片集
- **门户配置**: 自定义网站标题、SEO信息、主题设置
- **播放器配置**: 自定义播放器外观、水印、广告等

CMS前端使用Jade模板引擎和Layui框架，提供了友好的管理界面。

### 2.4 防盗链与安全机制

项目实现了多层防盗链机制：

- **Referer验证**: 检查请求来源域名
- **Token验证**: 对视频访问生成临时token
- **TS文件加密**: 对HLS切片文件进行加密
- **域名白名单**: 可配置允许访问的域名列表
- **移动端限制**: 可限制移动端浏览器访问

## 3. 数据库模型分析

项目使用MongoDB作为数据存储，主要包括以下模型：

### 3.1 Movie模型
```javascript
{
    status: String,     // 视频状态：waiting, transcoding, finished
    size: String,       // 文件大小
    category: String,   // 分类
    originalname: String, // 原始文件名
    poster: String,     // 海报图片路径
    count: Number,      // 播放次数
    path: String,       // 文件路径
    createAt: Date      // 创建时间
}
```

### 3.2 Setting模型
```javascript
{
    host: String,       // 网站主机地址
    hd: String,         // 高清设置
    antiurl: [String],  // 防盗链允许的URL列表
    antiredirect: String, // 防盗链重定向URL
    antikey: String,    // 防盗链密钥
    wmpath: String,     // 水印图片路径
    miaoqie: String,    // 秒切设置
    screenshots: Number, // 截图数量
    tsjiami: String,    // TS加密设置
    api: String,        // API开关
    createAt: Date      // 创建时间
}
```

### 3.3 Portal模型
```javascript
{
    host: String,       // 网站主机地址
    screenshots: Number, // 截图数量
    title: String,      // 网站标题
    seotitle: String,   // SEO标题
    keywords: String,   // SEO关键词
    kaiguan: String,    // CMS开关
    usersystem: String, // 会员系统开关
    description: String, // SEO描述
    moviestitle: String, // 电影页面标题
    images: String,     // 图集功能开关
    imagestitle: String, // 图集页面标题
    articles: String,   // 文章功能开关
    articlestitle: String, // 文章页面标题
    theme: String,      // 主题设置
    tongji: String,     // 统计代码
    createAt: Date      // 创建时间
}
```

## 4. 前端界面与用户交互

### 4.1 管理后台

管理后台使用Layui框架构建，提供了现代化的界面和交互体验：

- **视频上传界面**: 支持批量上传，使用dropzone.js实现
- **视频管理界面**: 支持分页、搜索、分类筛选、批量操作
- **转码管理**: 支持手动触发转码和队列转码
- **系统设置**: 支持配置网站基本信息、防盗链、水印等
- **用户管理**: 管理会员账户和卡券

### 4.2 门户前端

门户前端采用响应式设计，支持PC和移动设备：

- **首页**: 轮播图、最新视频、推荐内容
- **视频列表**: 支持分类筛选、搜索、分页
- **视频播放**: 使用DPlayer播放器，支持HLS、P2P加速、字幕、截图等
- **用户系统**: 登录、注册、会员开通
- **文章和图集**: 内容展示功能

## 5. 安全问题分析

### 5.1 高危安全问题

1. **密码明文存储**
   - 问题：用户密码直接以明文形式存储在数据库中
   - 风险：数据库泄露将直接暴露所有用户密码
   - 建议：使用bcrypt等安全哈希算法加密存储密码

2. **文件上传安全隐患**
   - 问题：文件上传缺乏严格的类型验证和大小限制
   - 风险：可能导致恶意文件上传，执行代码注入或消耗服务器资源
   - 建议：增加MIME类型验证、文件内容检查、大小限制、文件名随机化

3. **路径遍历漏洞**
   - 问题：文件操作中存在路径拼接，可能被利用进行路径遍历
   - 风险：攻击者可能访问或操作服务器上的敏感文件
   - 建议：使用path.normalize()规范化路径，限制文件操作范围

4. **CSRF防护缺失**
   - 问题：系统缺乏CSRF令牌验证机制
   - 风险：攻击者可能诱导用户执行非预期的操作
   - 建议：实现CSRF令牌验证，为每个会话生成唯一令牌

### 5.2 中危安全问题

1. **会话管理缺陷**
   - 问题：会话cookie配置不安全，没有设置httpOnly和secure标志
   - 风险：可能导致会话劫持攻击
   - 建议：设置cookie的httpOnly、secure和sameSite属性

2. **输入验证不足**
   - 问题：部分API和表单缺乏严格的输入验证
   - 风险：可能导致注入攻击或数据损坏
   - 建议：使用express-validator对所有用户输入进行验证

3. **敏感信息泄露**
   - 问题：错误处理可能泄露系统内部信息
   - 风险：攻击者可利用错误信息了解系统架构
   - 建议：自定义错误页面，避免暴露敏感错误信息

4. **依赖包安全**
   - 问题：使用了多个可能存在已知漏洞的依赖包
   - 风险：可能存在未修补的安全漏洞
   - 建议：定期更新依赖包，使用npm audit检查安全漏洞

## 6. 优化建议

### 6.1 性能优化

1. **转码任务队列优化**
   - 问题：当前队列机制较为简单，可能在高负载时效率低下
   - 建议：实现更完善的任务队列系统，支持优先级、失败重试、分布式处理

2. **缓存机制增强**
   - 问题：Redis缓存使用有限
   - 建议：增加对热点视频、分类列表等数据的缓存，减少数据库查询

3. **静态资源优化**
   - 问题：静态资源缺乏压缩和CDN分发
   - 建议：使用压缩中间件，配置CDN加速静态资源访问

4. **数据库索引优化**
   - 问题：部分查询可能缺乏适当的索引
   - 建议：为常用查询字段如category、createAt等创建索引

### 6.2 代码结构优化

1. **模块化重构**
   - 问题：部分功能模块过于庞大，如admin.js超过1500行
   - 建议：将功能拆分为更小的模块，提高可维护性

2. **错误处理统一**
   - 问题：错误处理方式不一致，缺乏统一的错误处理中间件
   - 建议：实现全局错误处理中间件，统一错误响应格式

3. **配置管理优化**
   - 问题：配置信息分散在多处
   - 建议：集中管理配置，支持环境变量配置

### 6.3 功能增强建议

1. **视频质量自适应**
   - 建议：实现自适应码率功能，根据用户网络状况自动切换清晰度

2. **多租户支持**
   - 建议：增加多租户功能，支持多用户独立管理自己的视频内容

3. **监控告警系统**
   - 建议：实现系统监控和告警机制，及时发现和处理异常

4. **数据分析功能**
   - 建议：增强统计分析功能，提供更详细的视频观看数据和用户行为分析

## 7. 总结与建议

### 7.1 项目优势

1. **功能全面**: 集成了视频转码、CMS、用户管理等完整功能
2. **技术成熟**: 使用了成熟的技术栈，易于维护和扩展
3. **安全机制**: 实现了多层防盗链和权限控制机制
4. **用户友好**: 提供了直观的管理界面和良好的用户体验

### 7.2 主要风险

1. **安全风险**: 密码存储、文件上传等方面存在明显安全隐患
2. **性能风险**: 在高并发场景下可能面临性能瓶颈
3. **维护风险**: 代码结构需要优化，提高可维护性

### 7.3 总体建议

1. **优先修复安全问题**: 特别是密码明文存储和文件上传安全问题
2. **优化转码性能**: 改进任务队列机制，提高转码效率
3. **完善监控和告警**: 建立系统监控，及时发现和处理问题
4. **定期更新依赖**: 保持依赖包的更新，修复已知安全漏洞
5. **代码重构**: 对关键模块进行重构，提高代码质量和可维护性

通过实施上述建议，可以显著提高系统的安全性、稳定性和性能，为用户提供更好的服务体验。